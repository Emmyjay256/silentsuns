<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Planets — TESS Orbit Viz</title>
  <style>
    :root{
      --bg:#0b0b0b; --ink:#fff; --muted:#cfd3dc; --card:#111318; --glass:rgba(0,0,0,.55);
      --accent:#00e5ff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
    a{color:#9cf}

    /* Page layout */
    .wrap{max-width:1100px;margin:0 auto;padding:28px 16px 64px}
    h1{font-size:38px;line-height:1.1;margin:0 0 8px}
    .lead{color:var(--muted);margin:0 0 20px}

    /* Sim card */
    .card{
      background:var(--card);
      border:1px solid #1a1d24;
      border-radius:16px;
      box-shadow:0 6px 24px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card + .card{ margin-top:18px; } /* (added) little gap between tiles */
    .card-head{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid #1a1d24;background:#0e1016;
    }
    .card-head h2{margin:0;font-size:16px;font-weight:700}
    .card-head .right{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:1px solid #2a2e3a;background:#131721;color:#eaf6ff;cursor:pointer;
      padding:8px 12px;border-radius:10px;font-weight:700;font-size:12px;letter-spacing:.3px;
    }
    .btn:hover{background:#0f1420}
    .hint{font-size:12px;color:#9fb0c8}

    /* Sim panel */
    .sim-panel{
      position:relative;width:100%;height:60vh;min-height:380px;background:#0a0c11;
    }

    /* Loading overlay */
    .overlay{
      position:absolute;inset:0;pointer-events:none;display:flex;align-items:flex-start;justify-content:center
    }
    .panel{
      margin-top:14px;background:var(--glass);backdrop-filter:saturate(140%) blur(6px);
      border-radius:10px;padding:10px 12px;font-size:12px;line-height:1.4;max-width:520px
    }
    .bar{height:4px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:6px}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#9cf,#9f9);transition:width .15s ease}
    .small{opacity:.85;font-size:11px;color:#ddd}
    .kbd{background:#222;border:1px solid #333;border-radius:4px;padding:1px 4px}

    /* Days HUD (top-right) */
    #daysHUD{
      position:absolute;top:12px;right:12px;pointer-events:none;
      z-index:2;text-align:right;
    }
    #daysHUD .title{
      font-weight:700;font-size:12px;letter-spacing:.6px;text-transform:uppercase;color:#a9cfe0;
    }
    #daysHUD .value{
      margin-top:2px;
      font-weight:900;font-size:32px;line-height:1;color:var(--accent);
      text-shadow:0 0 10px rgba(0,229,255,.35);
    }

    /* Layering */
    .sim-panel canvas{position:absolute;inset:0;z-index:0;display:block;filter:blur(10px)}
    .sim-panel .css2d{position:absolute;inset:0;pointer-events:none;z-index:1}
    #hud{ z-index:3; }

    /* Below content placeholder */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:18px}
    .note{background:#0e1016;border:1px solid #1a1d24;border-radius:12px;padding:14px;color:#cfe2ff}
  </style>

  <script type="importmap">
  {
    "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" }
  }
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Silent Planets</h1>
    <p class="lead">TESS transit candidates rendered as orbits. Choose Fullscreen when you’re ready to present.</p>

    <!-- ====================== EXISTING TILE (unchanged) ====================== -->
    <div class="card">
      <div class="card-head">
        <h2>Orbit Simulation</h2>
        <div class="right">
          <span class="hint">Controls: <span class="kbd">[</span> slower, <span class="kbd">]</span> faster, <span class="kbd">Space</span> pause</span>
          <button id="fsBtn" class="btn" type="button">Enter Fullscreen</button>
        </div>
      </div>

      <div id="sim" class="sim-panel">
        <div class="overlay" id="hud">
          <div class="panel">
            <div><b>Loading scene…</b> <span id="pct">0%</span></div>
            <div class="small" id="small">Preparing lights &amp; placeholders…</div>
            <div class="bar"><div class="fill" id="fill"></div></div>
          </div>
        </div>

        <!-- Top-right days HUD -->
        <div id="daysHUD">
          <div class="title">Elapsed earth days</div>
          <div class="value" id="daysText">0 days</div>
        </div>
      </div>
    </div>

    <!-- ====================== NEW TILE: Earth Viewer ====================== -->
    <div class="card">
      <div class="card-head">
        <h2>Earth Viewer (Preview)</h2>
        <div class="right">
          <span class="hint">GLB: <code>earth.glb</code> in this folder</span>
          <button id="earthFsBtn" class="btn" type="button">Enter Fullscreen</button>
        </div>
      </div>

      <div id="earthPanel" class="sim-panel">
        <!-- Progress HUD for Earth -->
        <div class="overlay" id="earthHud">
          <div class="panel">
            <div><b>Loading Earth…</b> <span id="earthPct">0%</span></div>
            <div class="small" id="earthSmall">Setting up lights &amp; controls…</div>
            <div class="bar"><div class="fill" id="earthFill"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- (Your notes grid stays) -->
    <div class="grid">
      <div class="note">Hook this to your backend payload. We’ll map <b>TIC</b>, <b>period</b>, <b>t0 (BTJD)</b>, and star type to the viz.</div>
      <div class="note">Add more sections here (model status, latest detections, controls, etc.).</div>
    </div>
  </div>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
  import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
  import { CSS2DRenderer } from 'https://unpkg.com/three@0.160.0/examples/jsm/renderers/CSS2DRenderer.js';

  // -------- Hard-coded demo data --------
  const received = {
    tic: 261136679,
    spectral_type: "A",          // K/M -> red.glb, G/F -> yellow.glb, A/B -> blue.glb
    period_days: 5.4321,
    t0_btjd: 134.5342,
    semi_major_axis_scene: 1.4,
    planet_radius_scene: 0.25,
    star_radius_scene: 0.7
  };

  const MIN_ORBIT_MULT = 8;
  if (received.semi_major_axis_scene < MIN_ORBIT_MULT * received.star_radius_scene) {
    received.semi_major_axis_scene = MIN_ORBIT_MULT * received.star_radius_scene;
  }

  let SIM_SPEED_DAYS_PER_SEC = 1.0;
  let paused = false;

  // DOM
  const simPanel = document.getElementById('sim');
  const fsBtn = document.getElementById('fsBtn');
  const pctEl = document.getElementById('pct');
  const fillEl = document.getElementById('fill');
  const smallEl = document.getElementById('small');
  const daysText = document.getElementById('daysText');
  const setProgress = (p)=>{ const v=Math.max(0,Math.min(100,p)); pctEl.textContent = v.toFixed(0)+'%'; fillEl.style.width = v+'%'; };

  // Scene / renderers
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0b0b);

  const camera = new THREE.PerspectiveCamera(70, 1, 0.1, 1000);
  camera.position.set(0, 1.2, 3.2);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace;
  else renderer.outputEncoding = THREE.sRGBEncoding;
  simPanel.appendChild(renderer.domElement);

  const labelRenderer = new CSS2DRenderer();
  labelRenderer.domElement.style.position = 'absolute';
  labelRenderer.domElement.style.inset = '0';
  labelRenderer.domElement.style.pointerEvents = 'none';
  labelRenderer.domElement.classList.add('css2d');
  simPanel.appendChild(labelRenderer.domElement);

  function sizeToPanel(){
    const w = simPanel.clientWidth, h = simPanel.clientHeight;
    camera.aspect = w / h; camera.updateProjectionMatrix();
    renderer.setSize(w, h, false);
    labelRenderer.setSize(w, h);
  }
  sizeToPanel();

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Lights
  const key   = new THREE.DirectionalLight(0xffffff, 1.0); key.position.set( 5, 5,  5);
  const fill  = new THREE.DirectionalLight(0xffffff, 0.55); fill.position.set(-5, 2,  5);
  const back  = new THREE.DirectionalLight(0xffffff, 0.75); back.position.set( 0, 5, -6);
  const amb   = new THREE.AmbientLight(0xffffff, 0.2);
  scene.add(key, fill, back, amb);

  // Placeholders
  const placeholderStarMat = new THREE.MeshStandardMaterial({
    color: 0xffcc66, emissive: 0xffaa33, emissiveIntensity: 0.6, roughness: 0.6, metalness: 0.0
  });
  const starPH = new THREE.Mesh(new THREE.SphereGeometry(received.star_radius_scene, 48, 24), placeholderStarMat);
  scene.add(starPH);

  const planetPH = new THREE.Mesh(
    new THREE.SphereGeometry(received.planet_radius_scene, 36, 18),
    new THREE.MeshStandardMaterial({ color: 0xffe199, emissive: 0xffcc66, emissiveIntensity: 0.7, roughness: 0.5 })
  );
  planetPH.position.set(received.semi_major_axis_scene, 0, 0);
  scene.add(planetPH);

  smallEl.textContent = 'Placeholders visible… loading GLB models';

  // Sun by spectral type
  function sunPathForSpectral(s) {
    const t = (s || '').toUpperCase();
    if (t.startsWith('K') || t.startsWith('M')) return './red.glb';
    if (t.startsWith('G') || t.startsWith('F')) return './yellow.glb';
    return './blue.glb';
  }

  // Loading manager + blur
  const manager = new THREE.LoadingManager();
  manager.onProgress = (_u, loaded, total)=>{ const p=total?(loaded/total)*100:50; setProgress(p); applyBlur(10*(1-p/100)); };
  manager.onLoad = ()=> setProgress(100);

  const loader = new GLTFLoader(manager);
  let currentBlur = 10;
  function applyBlur(px){ renderer.domElement.style.filter = `blur(${px}px)`; }

  // Load GLBs
  let starReal = null, planetReal = null, reveal = 0;

  loader.load(sunPathForSpectral(received.spectral_type), (gltf)=>{
    starReal = gltf.scene;
    starReal.scale.setScalar(received.star_radius_scene);
    starReal.traverse(o=>{ if (o.isMesh && o.material){ o.material = o.material.clone(); o.material.transparent = true; o.material.opacity = 0; }});
    scene.add(starReal);
    smallEl.textContent = 'Sun model loaded…';
    reveal = Math.max(reveal, 0.001);
  });

  loader.load('./planet.glb', (gltf)=>{
    planetReal = gltf.scene;
    planetReal.scale.setScalar(received.planet_radius_scene);
    planetReal.position.copy(planetPH.position);
    planetReal.traverse(o=>{ if (o.isMesh && o.material){ o.material = o.material.clone(); o.material.transparent = true; o.material.opacity = 0; }});
    scene.add(planetReal);
    smallEl.textContent = 'Planet model loaded…';
    reveal = Math.max(reveal, 0.001);
  });

  // Progress tube (growing arc)
  const TUBE_COLOR = 0x00e5ff;
  const tubeMaterial = new THREE.MeshBasicMaterial({ color: TUBE_COLOR, transparent: true, opacity: 0.95 });
  let progressMesh = null, arcStartTheta = null, lastTheta = null, orbitStartSimDays = 0;

  function updateProgressArc(R, startTheta, endTheta) {
    const delta = endTheta - startTheta;
    const steps = Math.max(8, Math.ceil(128 * (delta / (Math.PI * 2))));
    const pts = [];
    for (let i = 0; i <= steps; i++) {
      const t = i / steps;
      const th = startTheta + t * delta;
      pts.push(new THREE.Vector3(Math.cos(th) * R, 0, Math.sin(th) * R));
    }
    const curve = new THREE.CatmullRomCurve3(pts, false, 'catmullrom', 0.0);
    const tubularSegments = Math.max(24, steps * 3);
    const tubeRadius = Math.max(0.01, received.planet_radius_scene * 0.22);
    const geom = new THREE.TubeGeometry(curve, tubularSegments, tubeRadius, 6, false);
    if (!progressMesh) { progressMesh = new THREE.Mesh(geom, tubeMaterial); progressMesh.renderOrder = 2; scene.add(progressMesh); }
    else { progressMesh.geometry.dispose(); progressMesh.geometry = geom; }
  }

  // Sim time & orbit
  let simDays = 0, lastT = performance.now();
  function stepSim(nowMs){ const dt=(nowMs-lastT)/1000; lastT=nowMs; if(!paused) simDays += dt * SIM_SPEED_DAYS_PER_SEC; }
  const PI2 = Math.PI * 2;
  function orbitAngle(period_days, t0_btjd, current_btjd){
    const ph = ((current_btjd - t0_btjd) / period_days) % 1; return (ph < 0 ? ph + 1 : ph) * PI2;
  }
  const currentBTJD = ()=> received.t0_btjd + simDays;

  // Animate
  function animate(tMs){
    requestAnimationFrame(animate);
    stepSim(tMs);

    // star pulse + slow spin
    placeholderStarMat.emissiveIntensity = 0.6 + Math.sin(tMs*0.0012)*0.04;
    starPH.rotation.y += 0.001; if (starReal) starReal.rotation.y += 0.001;

    // planet self-rotation
    planetPH.rotation.y += 0.008; if (planetReal) planetReal.rotation.y += 0.01;

    // orbit path
    const R = received.semi_major_axis_scene;
    const theta = orbitAngle(received.period_days, received.t0_btjd, currentBTJD());
    const x = Math.cos(theta) * R, z = Math.sin(theta) * R;
    planetPH.position.set(x, 0, z); if (planetReal) planetReal.position.set(x, 0, z);

    // progress arc + elapsed (reset on wrap)
    if (arcStartTheta === null) {
      arcStartTheta = theta; lastTheta = theta; orbitStartSimDays = simDays;
      updateProgressArc(R, arcStartTheta, theta + 1e-6);
    } else {
      if (theta < lastTheta) { // wrapped
        arcStartTheta = theta; orbitStartSimDays = simDays;
        updateProgressArc(R, arcStartTheta, theta + 1e-6);
      } else {
        updateProgressArc(R, arcStartTheta, theta);
      }
      lastTheta = theta;
    }
    const orbitElapsed = simDays - orbitStartSimDays;
    // HUD text as whole days (no decimals)
    daysText.textContent = `${Math.floor(orbitElapsed)} days`;

    // reveal real models
    if (reveal > 0 && starReal && planetReal){
      reveal = Math.min(1, reveal + 0.03);
      const realOpacity = reveal;
      starReal.traverse(o=>{ if (o.isMesh && o.material) o.material.opacity = realOpacity; });
      planetReal.traverse(o=>{ if (o.isMesh && o.material) o.material.opacity = realOpacity; });
      starPH.visible = (1 - reveal) > 0.02; planetPH.visible = (1 - reveal) > 0.02;
      currentBlur = Math.max(0, currentBlur - 0.6); applyBlur(currentBlur);
      if (reveal === 1){ document.getElementById('hud').style.display='none'; applyBlur(0); }
    }

    controls.update();
    renderer.render(scene, camera);
    labelRenderer.render(scene, camera);
  }
  applyBlur(currentBlur);
  animate(0);

  // Resize & fullscreen
  addEventListener('resize', sizeToPanel);
  document.addEventListener('fullscreenchange', sizeToPanel);
  document.getElementById('fsBtn').addEventListener('click', async ()=>{
    if (!document.fullscreenElement){ await simPanel.requestFullscreen(); fsBtn.textContent='Exit Fullscreen'; }
    else { await document.exitFullscreen(); fsBtn.textContent='Enter Fullscreen'; }
    sizeToPanel();
  });

  // Keys
  addEventListener('keydown', (e)=>{
    if (e.key === '[') { SIM_SPEED_DAYS_PER_SEC = Math.max(0.01, SIM_SPEED_DAYS_PER_SEC / 1.5); smallEl.textContent = `Speed: ${SIM_SPEED_DAYS_PER_SEC.toFixed(2)} d/s (slower)`; }
    else if (e.key === ']') { SIM_SPEED_DAYS_PER_SEC = Math.min(1e3, SIM_SPEED_DAYS_PER_SEC * 1.5); smallEl.textContent = `Speed: ${SIM_SPEED_DAYS_PER_SEC.toFixed(2)} d/s (faster)`; }
    else if (e.code === 'Space') { paused = !paused; smallEl.textContent = paused ? 'Paused' : `Speed: ${SIM_SPEED_DAYS_PER_SEC.toFixed(2)} d/s`; }
  });

  setProgress(5);

  /* ====================== EARTH VIEWER: isolated block (no changes above) ====================== */
  (function initEarthViewer(){
    const panel   = document.getElementById('earthPanel');
    const fsBtn   = document.getElementById('earthFsBtn');
    const pctEl   = document.getElementById('earthPct');
    const fillEl  = document.getElementById('earthFill');
    const smallEl = document.getElementById('earthSmall');

    // Local helpers
    function setEarthProgress(p){
      const v = Math.max(0, Math.min(100, p));
      pctEl.textContent = v.toFixed(0) + '%';
      fillEl.style.width = v + '%';
    }
    function sizeEarthToPanel(camera, renderer){
      const w = panel.clientWidth, h = panel.clientHeight;
      camera.aspect = w / h; camera.updateProjectionMatrix();
      renderer.setSize(w, h, false);
    }

    // Scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0b0b);

    const camera = new THREE.PerspectiveCamera(70, 1, 0.1, 1000);
    camera.position.set(0, 0.8, 2.2);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace;
    else renderer.outputEncoding = THREE.sRGBEncoding;
    panel.appendChild(renderer.domElement);
    sizeEarthToPanel(camera, renderer);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Lights
    const amb  = new THREE.AmbientLight(0xffffff, 0.35);
    const key  = new THREE.DirectionalLight(0xffffff, 1.1); key.position.set( 5, 4,  6);
    const rim  = new THREE.DirectionalLight(0x99b7ff, 0.6); rim.position.set(-6, 2, -4);
    const hemi = new THREE.HemisphereLight(0x668cff, 0x0a0c11, 0.3);
    scene.add(amb, key, rim, hemi);

    // Progress / blur
    function applyEarthBlur(px){ renderer.domElement.style.filter = `blur(${px}px)`; }
    let blur = 10; applyEarthBlur(blur);

    const manager = new THREE.LoadingManager();
    manager.onProgress = (_url, loaded, total)=>{
      const p = total ? (loaded/total)*100 : 50;
      setEarthProgress(p);
      blur = 10 * (1 - p/100);
      applyEarthBlur(blur);
    };
    manager.onLoad = ()=>{
      setEarthProgress(100);
      applyEarthBlur(0);
      document.getElementById('earthHud').style.display = 'none';
    };

    // Load earth.glb
    const loader = new GLTFLoader(manager);
    let earth = null;
    loader.load(
      './earth.glb',
      (gltf)=>{
        earth = gltf.scene;
        earth.traverse(o=>{
          if (o.isMesh && o.material){
            o.material = o.material.clone();
          }
        });
        scene.add(earth);
        smallEl.textContent = 'Earth loaded.';
      },
      undefined,
      (err)=> smallEl.textContent = 'Load error: ' + (err?.message || err)
    );

    // Animate
    function animate(){
      requestAnimationFrame(animate);
      if (earth) earth.rotation.y += 0.0018;
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Resize & fullscreen (only for this panel)
    const onResize = ()=> sizeEarthToPanel(camera, renderer);
    addEventListener('resize', onResize);
    document.addEventListener('fullscreenchange', onResize);
    fsBtn.addEventListener('click', async ()=>{
      if (!document.fullscreenElement){ await panel.requestFullscreen(); fsBtn.textContent='Exit Fullscreen'; }
      else { await document.exitFullscreen(); fsBtn.textContent='Enter Fullscreen'; }
      sizeEarthToPanel(camera, renderer);
    });
  })();
</script>
</body>
</html>
