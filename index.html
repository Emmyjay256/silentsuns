<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Planets — TESS Orbit Viz + Earth Viewer</title>
  <style>
    :root{
      --bg:#0b0b0b; --ink:#fff; --muted:#cfd3dc; --card:#111318; --glass:rgba(0,0,0,.55);
      --accent:#00e5ff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
    a{color:#9cf}

    .wrap{max-width:1100px;margin:0 auto;padding:28px 16px 64px}
    h1{font-size:38px;line-height:1.1;margin:0 0 8px}
    .lead{color:var(--muted);margin:0 0 20px}

    .card{
      background:var(--card);
      border:1px solid #1a1d24;
      border-radius:16px;
      box-shadow:0 6px 24px rgba(0,0,0,.35);
      overflow:hidden;
      margin-top:18px;
    }
    .card-head{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid #1a1d24;background:#0e1016;
    }
    .card-head h2{margin:0;font-size:16px;font-weight:700}
    .card-head .right{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:1px solid #2a2e3a;background:#131721;color:#eaf6ff;cursor:pointer;
      padding:8px 12px;border-radius:10px;font-weight:700;font-size:12px;letter-spacing:.3px;
    }
    .btn:hover{background:#0f1420}
    .hint{font-size:12px;color:#9fb0c8}

    .sim-panel{
      position:relative;width:100%;height:60vh;min-height:380px;background:#0a0c11;
    }
    .overlay{position:absolute;inset:0;pointer-events:none;display:flex;align-items:flex-start;justify-content:center}
    .panel{margin-top:14px;background:var(--glass);backdrop-filter:saturate(140%) blur(6px);
      border-radius:10px;padding:10px 12px;font-size:12px;line-height:1.4;max-width:520px}
    .bar{height:4px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;margin-top:6px}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,#9cf,#9f9);transition:width .15s ease}
    .small{opacity:.85;font-size:11px;color:#ddd}
    .kbd{background:#222;border:1px solid #333;border-radius:4px;padding:1px 4px}

    /* Days HUD (top-right inside sim panel) */
    #daysHUD{
      position:absolute;top:12px;right:12px;pointer-events:none;
      font-weight:800;font-size:28px;line-height:1;color:var(--accent);
      text-shadow:0 0 10px rgba(0,229,255,.35);
    }
    #daysHUD small{font-weight:600;font-size:12px;opacity:.8;display:block}

    /* Blur while loading */
    .sim-panel canvas{display:block;filter:blur(10px)}
  </style>

  <script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Silent Planets</h1>
    <p class="lead">TESS transit candidates rendered as orbits. Below: Earth viewer (for later calibration & visibility).</p>

    <!-- ====== TOP: Orbit Simulation (your existing panel retained) ====== -->
    <div class="card">
      <div class="card-head">
        <h2>Orbit Simulation</h2>
        <div class="right">
          <span class="hint">Controls: <span class="kbd">[</span> slower, <span class="kbd">]</span> faster, <span class="kbd">Space</span> pause</span>
          <button id="fsBtn" class="btn" type="button">Enter Fullscreen</button>
        </div>
      </div>

      <div id="sim" class="sim-panel">
        <!-- Progress HUD -->
        <div class="overlay" id="hud">
          <div class="panel">
            <div><b>Loading scene…</b> <span id="pct">0%</span></div>
            <div class="small" id="small">Preparing lights &amp; placeholders…</div>
            <div class="bar"><div class="fill" id="fill"></div></div>
          </div>
        </div>

        <!-- Days HUD -->
        <div id="daysHUD"><small>elapsed (per orbit)</small><span id="daysText">0.00 d</span></div>
        <!-- WebGL canvas injected here -->
      </div>
    </div>

    <!-- ====== BOTTOM: Earth Viewer (new simple tile) ====== -->
    <div class="card">
      <div class="card-head">
        <h2>Earth Viewer (Preview)</h2>
        <div class="right">
          <span class="hint">GLB: <code>earth.glb</code> in same folder</span>
          <button id="earthFsBtn" class="btn" type="button">Enter Fullscreen</button>
        </div>
      </div>

      <div id="earth" class="sim-panel">
        <!-- Progress HUD -->
        <div class="overlay" id="earthHud">
          <div class="panel">
            <div><b>Loading Earth…</b> <span id="earthPct">0%</span></div>
            <div class="small" id="earthSmall">Setting up lights &amp; controls…</div>
            <div class="bar"><div class="fill" id="earthFill"></div></div>
          </div>
        </div>
        <!-- WebGL canvas injected here -->
      </div>
    </div>
  </div>

  <!-- ========= SCRIPTS ========= -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

    // -----------------------------
    // Helpers (progress + sizing)
    // -----------------------------
    function sizeToPanel(camera, renderer, panel){
      const w = panel.clientWidth, h = panel.clientHeight;
      camera.aspect = w / h; camera.updateProjectionMatrix();
      renderer.setSize(w, h, false);
    }
    function setProgress(pctEl, fillEl, p){
      const v = Math.max(0, Math.min(100, p));
      pctEl.textContent = v.toFixed(0) + '%';
      fillEl.style.width = v + '%';
    }
    function easeBlur(canvas, px){ canvas.style.filter = `blur(${px}px)`; }

    // =========================================================
    // TOP PANEL: keep your existing orbit sim bootstrapped here
    // (This is a minimal placeholder so your page still runs;
    // if you already have the full orbit script, paste it back.)
    // =========================================================
    (function initOrbitPlaceholder(){
      const panel = document.getElementById('sim');
      const fsBtn = document.getElementById('fsBtn');
      const pctEl = document.getElementById('pct');
      const fillEl = document.getElementById('fill');
      const smallEl = document.getElementById('small');
      const daysText = document.getElementById('daysText');

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0b0b);

      const camera = new THREE.PerspectiveCamera(70, 1, 0.1, 1000);
      camera.position.set(0, 1.2, 3.2);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace;
      else renderer.outputEncoding = THREE.sRGBEncoding;
      panel.appendChild(renderer.domElement);

      sizeToPanel(camera, renderer, panel);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Lights
      const key   = new THREE.DirectionalLight(0xffffff, 1.0); key.position.set( 5, 5,  5);
      const fill  = new THREE.DirectionalLight(0xffffff, 0.55); fill.position.set(-5, 2,  5);
      const back  = new THREE.DirectionalLight(0xffffff, 0.75); back.position.set( 0, 5, -6);
      const amb   = new THREE.AmbientLight(0xffffff, 0.2);
      scene.add(key, fill, back, amb);

      // Placeholder star + planet just so tile isn’t empty
      const star = new THREE.Mesh(new THREE.SphereGeometry(0.7, 48, 24),
        new THREE.MeshStandardMaterial({ color: 0xffcc66, emissive: 0xffaa33, emissiveIntensity: 0.6 }));
      const planet = new THREE.Mesh(new THREE.SphereGeometry(0.25, 36, 18),
        new THREE.MeshStandardMaterial({ color: 0x99caff, emissive: 0x3355ff, emissiveIntensity: 0.2 }));
      planet.position.set(1.8, 0, 0);
      scene.add(star, planet);

      // Simple progress dissolve of blur
      let blur = 10; easeBlur(renderer.domElement, blur);
      setProgress(pctEl, fillEl, 60);
      smallEl.textContent = 'Demo placeholder running…';

      // Animate
      function animate(t){
        requestAnimationFrame(animate);
        star.rotation.y += 0.0015;
        planet.rotation.y += 0.01;
        planet.position.set(Math.cos(t*0.0005)*1.8, 0, Math.sin(t*0.0005)*1.8);
        daysText.textContent = ((t*0.0002)%100).toFixed(2) + ' d';
        if (blur > 0){ blur = Math.max(0, blur - 0.15); easeBlur(renderer.domElement, blur); if (blur === 0){ document.getElementById('hud').style.display='none'; } }
        controls.update();
        renderer.render(scene, camera);
      }
      animate(0);

      // Resize + fullscreen
      addEventListener('resize', ()=> sizeToPanel(camera, renderer, panel));
      document.addEventListener('fullscreenchange', ()=> sizeToPanel(camera, renderer, panel));
      fsBtn.addEventListener('click', async ()=>{
        if (!document.fullscreenElement){ await panel.requestFullscreen(); fsBtn.textContent = 'Exit Fullscreen'; }
        else { await document.exitFullscreen(); fsBtn.textContent = 'Enter Fullscreen'; }
        sizeToPanel(camera, renderer, panel);
      });
    })();

    // ==========================================
    // BOTTOM PANEL: Earth viewer (NEW TILE)
    // Loads ./earth.glb with lights & controls.
    // ==========================================
    (function initEarthViewer(){
      const panel   = document.getElementById('earth');
      const fsBtn   = document.getElementById('earthFsBtn');
      const pctEl   = document.getElementById('earthPct');
      const fillEl  = document.getElementById('earthFill');
      const smallEl = document.getElementById('earthSmall');

      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0b0b);

      const camera = new THREE.PerspectiveCamera(70, 1, 0.1, 1000);
      camera.position.set(0, 0.7, 2.2);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace;
      else renderer.outputEncoding = THREE.sRGBEncoding;
      panel.appendChild(renderer.domElement);

      sizeToPanel(camera, renderer, panel);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.target.set(0,0,0);

      // Lights (a bit richer for Earth)
      const amb  = new THREE.AmbientLight(0xffffff, 0.35);
      const key  = new THREE.DirectionalLight(0xffffff, 1.1); key.position.set( 5, 4,  6);
      const rim  = new THREE.DirectionalLight(0x99b7ff, 0.6); rim.position.set(-6, 2, -4);
      const fill = new THREE.HemisphereLight(0x668cff, 0x0a0c11, 0.3);
      scene.add(amb, key, rim, fill);

      // Progress manager
      const manager = new THREE.LoadingManager();
      manager.onProgress = (_url, loaded, total)=>{
        const p = total ? (loaded/total)*100 : 50;
        setProgress(pctEl, fillEl, p);
        const blur = 10 * (1 - p/100);
        easeBlur(renderer.domElement, blur);
      };
      manager.onLoad = ()=> {
        setProgress(pctEl, fillEl, 100);
        smallEl.textContent = 'Earth ready.';
        easeBlur(renderer.domElement, 0);
        document.getElementById('earthHud').style.display = 'none';
      };

      // Load Earth model
      const loader = new GLTFLoader(manager);
      let earth = null;
      loader.load(
        './earth.glb',
        (gltf)=>{
          earth = gltf.scene;
          // Normalize scale in case the model isn’t unit-sized
          earth.scale.setScalar(1.0);
          earth.traverse(o=>{
            if (o.isMesh && o.material){
              // Ensure sRGB materials for correct colors
              o.material = o.material.clone();
            }
          });
          scene.add(earth);
          smallEl.textContent = 'Earth loaded…';
        },
        undefined,
        (err)=> { smallEl.textContent = 'Load error: ' + (err?.message || err); }
      );

      // Animate
      function animate(){
        requestAnimationFrame(animate);
        if (earth){ earth.rotation.y += 0.0018; } // gentle spin
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Resize + fullscreen
      addEventListener('resize', ()=> sizeToPanel(camera, renderer, panel));
      document.addEventListener('fullscreenchange', ()=> sizeToPanel(camera, renderer, panel));
      fsBtn.addEventListener('click', async ()=>{
        if (!document.fullscreenElement){ await panel.requestFullscreen(); fsBtn.textContent = 'Exit Fullscreen'; }
        else { await document.exitFullscreen(); fsBtn.textContent = 'Enter Fullscreen'; }
        sizeToPanel(camera, renderer, panel);
      });
    })();
  </script>
</body>
</html>
